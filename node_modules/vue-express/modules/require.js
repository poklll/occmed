var fs = require('fs')
var path = require('path')
var compiler = require('vueify-sync').compiler

// 将当前路径加入解析路径
module.paths.push(__dirname)

var modules = {
    'vueify-insert-css': require('./vueify-insert-css')
}

const localRequire = function (moduleId) {
  if (modules.hasOwnProperty(moduleId)) {
      return modules[moduleId]
  }

  var cwd = this.path
  if (this === global) {
      cwd = process.cwd()
  }

  var pathname = path.resolve(cwd, moduleId)
  if (!/.vue$/.test(moduleId)) {
      if (moduleId[0] === '.') {
          moduleId = pathname
      }
      return require(moduleId)
  }
  let content = fs.readFileSync(pathname).toString('utf8')
  const result = compiler.compileSync(content.toString('utf8'), './')
  const idx = pathname.lastIndexOf('/')
  return resolve(result, pathname.substr(0, idx))
}

function resolve(content, cwd) {
    const exports = {
      __esModule: true
    }
    const module = {
        path: cwd || process.cwd(),
        exports: exports
    }
    const require = localRequire.bind(module)
    eval(content)
    return module.exports
}

module.exports = localRequire